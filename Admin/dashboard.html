<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Admin Panel</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <div>
                <h1>Admin Dashboard</h1>
                <p class="admin-info"></p>
            </div>
            <button class="logout-btn" onclick="logout()">Đăng xuất</button>
        </div>

        <nav class="nav-menu">
            <a href="dashboard.html" class="nav-item active">Dashboard</a>
            <a href="manage-customers.html" class="nav-item">Quản lý Khách hàng</a>
            <a href="manage-orders.html" class="nav-item">Quản lý Đơn hàng</a>
            <a href="manage-products.html" class="nav-item">Quản lý Sản phẩm</a>
            <a href="manage-categories.html" class="nav-item">Quản lý Danh mục</a>
        </nav>

        <div class="content-box">
            <h2>Tổng quan hệ thống</h2>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <h3>Tổng số khách hàng</h3>
                    <div class="number" id="totalCustomers">0</div>
                </div>
                <div class="stat-card">
                    <h3>Tổng số sản phẩm</h3>
                    <div class="number" id="totalProducts">0</div>
                </div>
                <div class="stat-card">
                    <h3>Tổng số đơn hàng</h3>
                    <div class="number" id="totalOrders">0</div>
                </div>
                <div class="stat-card">
                    <h3>Doanh thu tháng này</h3>
                    <div class="number" id="totalRevenue">0đ</div>
                </div>
            </div>

            <div class="table-container">
                <h3>Lịch sử giao dịch</h3>
                <table id="transactionHistory">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Khách hàng</th>
                            <th>Tên sản phẩm</th>
                            <th>Số sản phẩm</th>
                            <th>Tổng tiền</th>
                            <th>Ngày đặt</th>
                            <th>Trạng thái</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <script src="admin.js"></script>
    <script>
        // Load dashboard data
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                // Show loading
                document.getElementById('totalCustomers').textContent = '...';
                document.getElementById('totalProducts').textContent = '...';
                document.getElementById('totalOrders').textContent = '...';
                document.getElementById('totalRevenue').textContent = '...';
                
                const tbody = document.querySelector('#transactionHistory tbody');
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 20px;">Đang tải dữ liệu...</td></tr>';

                // Load data from API
                const [customers, products, ordersRaw] = await Promise.all([
                    loadData('customers'),
                    loadData('products'),
                    loadData('orders')
                ]);
                
                // Transform orders to ensure customer names are loaded properly
                const orders = await Promise.all(ordersRaw.map(async (order) => {
                    // If customer is just an ID, fetch the user info
                    if (order.customerId && (!order.customer || order.customer === order.customerId)) {
                        try {
                            const userRes = await apiCall(`/user/${order.customerId}`);
                            const user = userRes.user || userRes.data || userRes;
                            order.customer = user.ho_ten || user.ten_dang_nhap || user.email || order.customer || 'N/A';
                        } catch (err) {
                            console.warn(`Could not fetch user ${order.customerId}:`, err);
                        }
                    }
                    return order;
                }));

                // Update stats
                document.getElementById('totalCustomers').textContent = customers.length;
                document.getElementById('totalProducts').textContent = products.length;
                document.getElementById('totalOrders').textContent = orders.length;

                // Calculate revenue for current month
                const now = new Date();
                const currentMonth = now.getMonth();
                const currentYear = now.getFullYear();
                const monthlyRevenue = orders
                    .filter(order => {
                        const orderDate = new Date(order.date);
                        return orderDate.getMonth() === currentMonth && orderDate.getFullYear() === currentYear;
                    })
                    .reduce((sum, order) => sum + (order.total || 0), 0);
                document.getElementById('totalRevenue').textContent = formatCurrency(monthlyRevenue);

                // Display all orders (transaction history) - sorted by date (newest first)
                const sortedOrders = [...orders].sort((a, b) => {
                    const dateA = new Date(a.date || 0);
                    const dateB = new Date(b.date || 0);
                    return dateB - dateA; // Newest first
                });
                
                tbody.innerHTML = '';
                
                if (sortedOrders.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 20px;">Chưa có giao dịch nào</td></tr>';
                } else {
                    sortedOrders.forEach(order => {
                        const row = document.createElement('tr');
                        const orderId = String(order.id || order._id || '').substring(0, 8);
                        const statusValue = order.status || 'pending';
                        const productNames = (order.items || [])
                            .map(item => item.ten_san_pham || item.product_name || item.name || item?.san_pham?.ten_san_pham || item?.product?.name)
                            .filter(Boolean)
                            .slice(0, 2) // Show max 2 product names
                            .join(', ');
                        const productCount = order.items?.length || 0;
                        
                        // Get status display name
                        const statusNames = {
                            'pending': 'Chờ xử lý',
                            'confirmed': 'Đã xác nhận',
                            'shipping': 'Đang vận chuyển',
                            'delivered': 'Hoàn thành',
                            'cancelled': 'Đã hủy'
                        };
                        const statusDisplay = statusNames[statusValue] || statusValue;
                        
                        row.innerHTML = `
                            <td>#${orderId}</td>
                            <td>${order.customer || 'N/A'}</td>
                            <td>${productNames || 'N/A'}${productCount > 2 ? ` và ${productCount - 2} sản phẩm khác` : ''}</td>
                            <td>${productCount}</td>
                            <td>${formatCurrency(order.total || 0)}</td>
                            <td>${formatDate(order.date)}</td>
                            <td><span class="badge ${statusValue}">${statusDisplay}</span></td>
                        `;
                        tbody.appendChild(row);
                    });
                }
            } catch (error) {
                console.error('Error loading dashboard:', error);
                document.getElementById('totalCustomers').textContent = 'Lỗi';
                document.getElementById('totalProducts').textContent = 'Lỗi';
                document.getElementById('totalOrders').textContent = 'Lỗi';
                document.getElementById('totalRevenue').textContent = 'Lỗi';
                
                const tbody = document.querySelector('#transactionHistory tbody');
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 20px; color: #dc3545;">Không thể tải dữ liệu. Vui lòng kiểm tra kết nối API.</td></tr>';
            }
        });
    </script>
</body>
</html>

